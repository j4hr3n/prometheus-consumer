# Prometheus metrics consumer

A prometheus based streaming consumer for metric streams.

## How it works

This module understands metric streams generated by @metrics/client and makes
opinionated (but overridable) decisions about how to create prometheus metrics from
them.

**An Example.**

Given a metric with a time value:

```js
{
    name: 'my_metric_with_time',
    description: 'Metric that measures time',
    time: 1231432423
}
```

`@metrics/prometheus-consumer` will either create a new prometheus Histogram for
`my_metric_with_time` or update one if it already exists.

## Usage

### Step 1.

Create a new instance of `@metrics/prometheus-consumer` to be our metrics consumer.

```js
const metricsConsumer = new PrometheusConsumer();
```

### Step 2.

Pipe the metrics output stream directly into our consumer

```js
const client = new MetricsClient();

client.pipe(metricsConsumer);
```

## API

### new PrometheusConsumer(options)

Create a new metrics consumer instance ready to have metrics piped into it.

**options**

| name             | description                                                                                | type     | default |
| ---------------- | ------------------------------------------------------------------------------------------ | -------- | ------- |
| bucketStepStart  | Value to start bucket generation from. Each step increases from here by `bucketStepFactor` | `number` | 0.001   |
| bucketStepFactor | Scaling factor for bucket creation. Must be > 1                                            | `number` | 1.15    |
| bucketStepCount  | Number of times `bucketStepFactor` should be applied to `bucketStepStart`                  | `number` | 45      |

_Example_

```js
const consumer = new PrometheusConsumer({
    bucketStepStart: 1,
    bucketStepFactor: 2,
    bucketStepCount: 8,
});
```

This example will use buckets: 1,2,4,8,16,32,64,128,256

### instance.override(name, config)

Override handling of a specific metric (by name). This is useful if the defaults
do not produce the desired result for a given metric. You can change what type
of prometheus metrics are generated by setting `type` and for histograms, you
can override bucket handling.

**name**

An alpha-numeric (plus the underscore character) string name of metric to be
overriden. Any metrics that match this name will be processed using the override
config (see below)

**config**

| name    | description                                                                 | type       | default   |
| ------- | --------------------------------------------------------------------------- | ---------- | --------- |
| type    | Either `histogram` or `counter`                                             | `string`   |           |
| labels  | Array with allowed values: `url`, `method`, `status`, `layout` and `podlet` | `string[]` |           |
| buckets | An object, see `config.buckets` below                                       | `object`   | see below |

**config.buckets**

| name             | description                                                                                | type     | default |
| ---------------- | ------------------------------------------------------------------------------------------ | -------- | ------- |
| bucketStepStart  | Value to start bucket generation from. Each step increases from here by `bucketStepFactor` | `number` | 0.001   |
| bucketStepFactor | Scaling factor for bucket creation. Must be > 1                                            | `number` | 1.15    |
| bucketStepCount  | Number of times `bucketStepFactor` should be applied to `bucketStepStart`                  | `number` | 45      |

_Example_

Override a specific time based metric to only be handled as a counter.

```js
consumer.override('my_time_based_metric', { type: 'counter' });
```

_Example_

Override labels for a metric.

```js
consumer.override('my_time_based_metric', {
    labels: ['url', 'method'],
});
```

_Example_

Override buckets for a specific time based metric.

```js
consumer.override('my_time_based_metric', {
    buckets: {
        bucketStepStart: 1,
        bucketStepFactor: 2,
        bucketStepCount: 8,
    },
});
```
